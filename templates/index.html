<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Chat Saude v1.0.0</title>
  <a href="{{ url_for('logout') }}" class="logout-btn">Logout</a>
  
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/choices.js/public/assets/styles/choices.min.css"/>
  <script src="https://cdn.jsdelivr.net/npm/choices.js/public/assets/scripts/choices.min.js"></script>

  <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
</head>
<body>

  <div class="chat-container">
    <header class="chat-header">
      <img src="{{ url_for('static', filename='images/logo1.jpeg') }}" alt="Logo do Chat Saude" class="logo">
      <h1>Chat Saude</h1>
    </header>

    <div id="messages" class="messages">
      <div class="message bot">
        <span>Ola! Para consultas detalhadas, insira um ID de paciente e sua pergunta. Para listar pacientes, use os filtros abaixo.</span>
      </div>
    </div>

    <div class="filter-container">
        <input type="number" id="idadeMin" placeholder="Idade Minima" />
        <input type="number" id="idadeMax" placeholder="Idade Maxima" />
        
        <select id="convenioFilter" multiple>
        </select>
        
        <select id="profissionalFilter" multiple>
        </select>

        <select id="conjuntoFilter" multiple>
        </select>

        <button id="filterBtn">Filtrar Pacientes</button>
    </div>
    <hr>

    <div class="input-container" style="flex-direction: column;">
      <input type="text" id="patientId" placeholder="ID do Paciente (para consultas com IA)" style="margin-bottom: 8px; padding: 0.5rem; border: 1px solid var(--border); border-radius: var(--radius); width: 100%;" />
      <div style="display: flex; gap: 0.5rem; width: 100%;">
        <textarea id="prompt" placeholder="Digite sua pergunta para o paciente selecionado..." rows="1" style="flex: 1;"></textarea>
        <button id="sendBtn">Enviar</button>
      </div>
    </div>
  </div>

  <script>
    const messagesEl = document.getElementById("messages");

    function createMessage(text, who = "user") {
      const div = document.createElement("div");
      div.className = `message ${who}`;

      if (who === "bot") {
        div.innerHTML = marked.parse(text);
        
        const codeBlock = div.querySelector('pre code.language-python');
        if (codeBlock) {
          const plotButton = document.createElement('button');
          plotButton.innerText = 'Gerar Grafico';
          plotButton.className = 'plot-button'; 
          
          codeBlock.parentElement.insertAdjacentElement('afterend', plotButton);

          plotButton.addEventListener('click', async () => {
              const code = codeBlock.innerText;
              plotButton.innerText = 'Gerando...';
              plotButton.disabled = true;

              try {
                  const res = await fetch('/plot', {
                      method: 'POST',
                      headers: { 'Content-Type': 'application/json' },
                      body: JSON.stringify({ code: code })
                  });
                  
                  const data = await res.json();

                  if (res.ok) {
                      const img = document.createElement('img');
                      img.src = `data:image/png;base64,${data.image_base64}`;
                      img.alt = "Grafico Gerado";
                      img.style.maxWidth = '100%';
                      img.style.marginTop = '1rem';
                      
                      plotButton.insertAdjacentElement('afterend', img);
                      plotButton.style.display = 'none'; 
                  } else {
                      const errorSpan = document.createElement('span');
                      errorSpan.style.color = 'red';
                      errorSpan.style.display = 'block';
                      errorSpan.style.marginTop = '0.5rem';
                      errorSpan.innerText = `Erro: ${data.error || 'Nao foi possivel gerar o grafico.'}`;
                      plotButton.insertAdjacentElement('afterend', errorSpan);
                      plotButton.innerText = 'Tentar Novamente';
                      plotButton.disabled = false;
                  }
              } catch (error) {
                  console.error("Erro no fetch do plot:", error);
                  plotButton.innerText = 'Erro de Conexao';
              }
          });
        }
      } else {
        const span = document.createElement("span");
        span.innerText = text;
        div.appendChild(span);
      }
      
      messagesEl.appendChild(div);
      messagesEl.scrollTop = messagesEl.scrollHeight;
    }

    async function enviarPrompt(texto = null) {
      const textarea = document.getElementById("prompt");
      const patientId = document.getElementById("patientId").value.trim();
      const promptValue = texto !== null ? texto : textarea.value.trim();

      if (!promptValue || !patientId) {
        if (!patientId) alert("Por favor, insira o ID do Paciente.");
        if (!promptValue) alert("Por favor, digite uma pergunta.");
        return;
      }

      textarea.value = "";
      createMessage(promptValue, "user");

      const loadingDiv = document.createElement("div");
      loadingDiv.className = "message bot-loading";
      loadingDiv.innerHTML = "<span>Carregando...</span>";
      messagesEl.appendChild(loadingDiv);
      messagesEl.scrollTop = messagesEl.scrollHeight;

      try {
        const res = await fetch("/prompt", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ prompt: promptValue, patient_id: patientId })
        });

        const data = await res.json();
        const loading = document.querySelector(".bot-loading");
        if (loading) loading.remove();

        if (res.ok) {
            createMessage(data.resposta || "Nao foi possivel obter uma resposta.", "bot");
        } else {
            createMessage(data.error || "Ocorreu um erro no servidor.", "bot");
        }

      } catch (error) {
        const loading = document.querySelector(".bot-loading");
        if (loading) loading.remove();
        createMessage("Erro ao conectar com o servidor. Verifique sua conexao.", "bot");
      }
    }

    // --- ALTERADO: Funcao de filtragem atualizada ---
    async function filtrarPacientes() {
        const idadeMin = document.getElementById("idadeMin").value;
        const idadeMax = document.getElementById("idadeMax").value;
        
        const conveniosEl = document.getElementById("convenioFilter");
        const convenios = [...conveniosEl.selectedOptions].map(option => option.value);

        const profissionaisEl = document.getElementById("profissionalFilter");
        const profissionais = [...profissionaisEl.selectedOptions].map(option => option.value);

        // NOVO: Pega os valores do filtro de conjunto
        const conjuntosEl = document.getElementById("conjuntoFilter");
        const conjuntos = [...conjuntosEl.selectedOptions].map(option => option.value);

        // ALTERADO: Validacao agora inclui o novo filtro
        if (!idadeMin && !idadeMax && convenios.length === 0 && profissionais.length === 0 && conjuntos.length === 0) {
            alert("Por favor, preencha ao menos um filtro para realizar a busca.");
            return;
        }
        if ((idadeMin && !idadeMax) || (!idadeMin && idadeMax)) {
            alert("Para filtrar por idade, por favor, preencha tanto a idade minima quanto a maxima.");
            return;
        }

        let userMessageParts = [];
        if (idadeMin && idadeMax) {
            userMessageParts.push(`idade entre ${idadeMin} e ${idadeMax} anos`);
        }
        if (convenios.length > 0) {
            userMessageParts.push(`convenios: ${convenios.join(", ")}`);
        }
        if (profissionais.length > 0) {
            userMessageParts.push(`atendidos por: ${profissionais.join(", ")}`);
        }
        // NOVO: Adiciona os conjuntos na mensagem do usuario
        if (conjuntos.length > 0) {
            userMessageParts.push(`conjuntos: ${conjuntos.join(", ")}`);
        }
        let userMessage = `Buscando pacientes com ${userMessageParts.join(", ")}.`;
        createMessage(userMessage, "user");

        const loadingDiv = document.createElement("div");
        loadingDiv.className = "message bot-loading";
        loadingDiv.innerHTML = "<span>Filtrando...</span>";
        messagesEl.appendChild(loadingDiv);
        messagesEl.scrollTop = messagesEl.scrollHeight;

        try {
            // ALTERADO: Envia o novo filtro no corpo da requisicao
            const res = await fetch("/filter", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ 
                    idade_min: idadeMin, 
                    idade_max: idadeMax,
                    convenios: convenios,
                    profissionais: profissionais,
                    conjuntos: conjuntos 
                })
            });

            const data = await res.json();
            const loading = document.querySelector(".bot-loading");
            if (loading) loading.remove();

            if (res.ok) {
                createMessage(data.resposta, "bot");
            } else {
                createMessage(data.error || "Ocorreu um erro no servidor.", "bot");
            }
        } catch (error) {
            const loading = document.querySelector(".bot-loading");
            if (loading) loading.remove();
            createMessage("Erro ao conectar com o servidor. Verifique sua conexao.", "bot");
        }
    }

    // --- ALTERADO: Funcao para popular filtros atualizada ---
    async function popularFiltros() {
      const commonChoiceOptions = {
          removeItemButton: true,
          placeholder: true,
          searchResultLimit: 10,
          noResultsText: 'Nenhum resultado encontrado',
          itemSelectText: 'Pressione para selecionar',
      };
      
      try {
        const resConv = await fetch('/convenios');
        const convenios = await resConv.json();
        const convenioSelect = document.getElementById('convenioFilter');
        convenios.forEach(conv => {
          const option = document.createElement('option');
          option.value = conv;
          option.textContent = conv;
          convenioSelect.appendChild(option);
        });
        new Choices(convenioSelect, {
            ...commonChoiceOptions,
            placeholderValue: 'Selecione convenios',
            searchPlaceholderValue: 'Pesquisar convenio...'
        });
      } catch (error) {
        console.error("Erro ao buscar convenios:", error);
      }

      try {
        const resProf = await fetch('/profissionais');
        const profissionais = await resProf.json();
        const profissionalSelect = document.getElementById('profissionalFilter');
        profissionais.forEach(prof => {
            const option = document.createElement('option');
            option.value = prof;
            option.textContent = prof;
            profissionalSelect.appendChild(option);
        });
        new Choices(profissionalSelect, {
            ...commonChoiceOptions,
            placeholderValue: 'Selecione medicos',
            searchPlaceholderValue: 'Pesquisar medico...'
        });
      } catch (error) {
        console.error("Erro ao buscar profissionais:", error);
      }

      // NOVO: Popula e inicializa o filtro de conjuntos
      try {
        const resConj = await fetch('/conjuntos');
        const conjuntos = await resConj.json();
        const conjuntoSelect = document.getElementById('conjuntoFilter');
        conjuntos.forEach(conj => {
            const option = document.createElement('option');
            option.value = conj;
            option.textContent = conj;
            conjuntoSelect.appendChild(option);
        });
        new Choices(conjuntoSelect, {
            ...commonChoiceOptions,
            placeholderValue: 'Selecione conjuntos',
            searchPlaceholderValue: 'Pesquisar conjunto...'
        });
      } catch (error) {
        console.error("Erro ao buscar conjuntos:", error);
      }
    }

    // --- EVENT LISTENERS ---
    document.getElementById("filterBtn").addEventListener("click", filtrarPacientes);
    document.getElementById("sendBtn").addEventListener("click", () => enviarPrompt());
    document.getElementById("prompt").addEventListener("keydown", e => {
      if (e.key === "Enter" && !e.shiftKey) {
        e.preventDefault();
        enviarPrompt();
      }
    });
      
    document.addEventListener('DOMContentLoaded', popularFiltros);
  </script>
</body>
</html>